name: deploy-azure

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  APP_NAME: paw

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Resolve deployment settings
        shell: bash
        run: |
          echo "RESOURCE_GROUP=${{ vars.AZURE_RESOURCE_GROUP }}" >> "$GITHUB_ENV"
          echo "LOCATION=${{ vars.AZURE_LOCATION }}" >> "$GITHUB_ENV"
          echo "NAME_PREFIX=${{ vars.AZURE_NAME_PREFIX }}" >> "$GITHUB_ENV"
          VM_ADMIN_USERNAME="${{ vars.AZURE_VM_ADMIN_USERNAME }}"
          if [ -z "$VM_ADMIN_USERNAME" ]; then
            VM_ADMIN_USERNAME="paw"
          fi
          echo "VM_ADMIN_USERNAME=$VM_ADMIN_USERNAME" >> "$GITHUB_ENV"

      - name: Validate required variables
        shell: bash
        run: |
          test -n "$RESOURCE_GROUP" || (echo "Missing repo variable AZURE_RESOURCE_GROUP" && exit 1)
          test -n "$LOCATION" || (echo "Missing repo variable AZURE_LOCATION" && exit 1)
          test -n "$NAME_PREFIX" || (echo "Missing repo variable AZURE_NAME_PREFIX" && exit 1)
          test -n "$VM_ADMIN_USERNAME" || (echo "Missing repo variable AZURE_VM_ADMIN_USERNAME" && exit 1)
          test -n "${{ secrets.AZURE_VM_SSH_PUBLIC_KEY }}" || (echo "Missing repo secret AZURE_VM_SSH_PUBLIC_KEY" && exit 1)
          test -n "${{ secrets.PAW_LLM_API_KEY }}" || (echo "Missing repo secret PAW_LLM_API_KEY" && exit 1)
          test -n "${{ secrets.PAW_TELEGRAM_BOT_TOKEN }}" || (echo "Missing repo secret PAW_TELEGRAM_BOT_TOKEN" && exit 1)

      - name: Ensure resource group exists
        shell: bash
        run: |
          az group create --name "$RESOURCE_GROUP" --location "$LOCATION"

      - name: Bootstrap Azure infra (single VM + ACR)
        shell: bash
        run: |
          az deployment group create \
            --resource-group "$RESOURCE_GROUP" \
            --name paw-bootstrap \
            --template-file infra/azure/main.bicep \
            --parameters \
              namePrefix="$NAME_PREFIX" \
              location="$LOCATION" \
              vmAdminUsername="$VM_ADMIN_USERNAME" \
              vmSshPublicKey="${{ secrets.AZURE_VM_SSH_PUBLIC_KEY }}"

      - name: Read infra outputs
        shell: bash
        run: |
          ACR_NAME=$(az deployment group show -g "$RESOURCE_GROUP" -n paw-bootstrap --query properties.outputs.acrName.value -o tsv)
          ACR_LOGIN_SERVER=$(az deployment group show -g "$RESOURCE_GROUP" -n paw-bootstrap --query properties.outputs.acrLoginServer.value -o tsv)
          VM_NAME=$(az deployment group show -g "$RESOURCE_GROUP" -n paw-bootstrap --query properties.outputs.vmName.value -o tsv)
          VM_PUBLIC_IP=$(az deployment group show -g "$RESOURCE_GROUP" -n paw-bootstrap --query properties.outputs.vmPublicIp.value -o tsv)

          echo "ACR_NAME=$ACR_NAME" >> "$GITHUB_ENV"
          echo "ACR_LOGIN_SERVER=$ACR_LOGIN_SERVER" >> "$GITHUB_ENV"
          echo "VM_NAME=$VM_NAME" >> "$GITHUB_ENV"
          echo "VM_PUBLIC_IP=$VM_PUBLIC_IP" >> "$GITHUB_ENV"

      - name: Login to ACR
        shell: bash
        run: |
          az acr login --name "$ACR_NAME"

      - name: Build and push image
        shell: bash
        run: |
          IMAGE_SHA="$ACR_LOGIN_SERVER/paw:${GITHUB_SHA}"
          IMAGE_LATEST="$ACR_LOGIN_SERVER/paw:latest"

          docker build -t "$IMAGE_SHA" -t "$IMAGE_LATEST" .
          docker push "$IMAGE_SHA"
          docker push "$IMAGE_LATEST"

          echo "PAW_IMAGE=$IMAGE_SHA" >> "$GITHUB_ENV"

      - name: Fetch ACR admin credentials
        shell: bash
        run: |
          ACR_USERNAME=$(az acr credential show --name "$ACR_NAME" --query username -o tsv)
          ACR_PASSWORD=$(az acr credential show --name "$ACR_NAME" --query "passwords[0].value" -o tsv)

          echo "ACR_USERNAME=$ACR_USERNAME" >> "$GITHUB_ENV"
          echo "ACR_PASSWORD=$ACR_PASSWORD" >> "$GITHUB_ENV"

      - name: Deploy containers on VM
        shell: bash
        run: |
          TELEGRAM_DM_POLICY="${{ vars.PAW_TELEGRAM_DM_POLICY }}"
          if [ -z "$TELEGRAM_DM_POLICY" ]; then
            TELEGRAM_DM_POLICY="open"
          fi
          TELEGRAM_ALLOW_FROM="${{ vars.PAW_TELEGRAM_ALLOW_FROM }}"

          ENV_B64=$(base64 -w0 <<EOF
          PAW_LLM__API_KEY=${{ secrets.PAW_LLM_API_KEY }}
          PAW_LLM__MODEL=openai/gpt-5-mini
          PAW_LLM__SMART_MODEL=openai/gpt-5.3-codex
          PAW_API_KEY=${{ secrets.PAW_API_KEY }}
          PAW_TELEGRAM_ENABLED=true
          PAW_TELEGRAM_BOT_TOKEN=${{ secrets.PAW_TELEGRAM_BOT_TOKEN }}
          PAW_TELEGRAM_DM_POLICY=$TELEGRAM_DM_POLICY
          PAW_TELEGRAM_ALLOW_FROM=$TELEGRAM_ALLOW_FROM
          PAW_DATABASE_URL=postgresql://paw:paw@postgres:5432/paw?sslmode=disable
          EOF
          )

          COMPOSE_B64=$(base64 -w0 <<EOF
          services:
            postgres:
              image: postgres:16-alpine
              container_name: paw-postgres
              restart: unless-stopped
              environment:
                POSTGRES_DB: paw
                POSTGRES_USER: paw
                POSTGRES_PASSWORD: paw
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U paw -d paw"]
                interval: 10s
                timeout: 5s
                retries: 5
              volumes:
                - /opt/paw/postgres:/var/lib/postgresql/data

            paw:
              image: ${PAW_IMAGE}
              container_name: paw
              restart: unless-stopped
              ports:
                - "8000:8000"
              depends_on:
                postgres:
                  condition: service_healthy
              env_file:
                - /opt/paw/.env
              environment:
                - PAW_LOG_FORMAT=console
                - PAW_DATABASE_URL=postgresql://paw:paw@postgres:5432/paw?sslmode=disable
              volumes:
                - /opt/paw/data:/home/paw/data
                - /opt/paw/plugins:/home/paw/plugins
                - /opt/paw/workspace:/home/paw/workspace
          EOF
          )

          az vm run-command invoke \
            --resource-group "$RESOURCE_GROUP" \
            --name "$VM_NAME" \
            --command-id RunShellScript \
            --scripts '
              set -e
              sudo mkdir -p /opt/paw/data /opt/paw/plugins /opt/paw/workspace /opt/paw/postgres
              echo '$ENV_B64' | base64 -d | sudo tee /opt/paw/.env >/dev/null
              echo '$COMPOSE_B64' | base64 -d | sudo tee /opt/paw/docker-compose.yml >/dev/null
              sudo chown -R 1000:1000 /opt/paw/data /opt/paw/plugins /opt/paw/workspace

              sudo apt-get update
              if ! command -v docker >/dev/null 2>&1; then
                sudo apt-get install -y docker.io docker-compose-v2 || sudo apt-get install -y docker.io docker-compose-plugin
              fi
              sudo systemctl enable --now docker

              sudo docker login ${{ env.ACR_LOGIN_SERVER }} -u ${{ env.ACR_USERNAME }} -p ${{ env.ACR_PASSWORD }}
              sudo docker compose -f /opt/paw/docker-compose.yml pull
              sudo docker compose -f /opt/paw/docker-compose.yml up -d
            '

      - name: Print app URL
        shell: bash
        run: |
          echo "PAW is deployed at: http://$VM_PUBLIC_IP:8000"
